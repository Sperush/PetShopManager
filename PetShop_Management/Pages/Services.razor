@page "/services"
@using PetShop_Server.Models
@using System.Net.Http.Json
@inject HttpClient Http

<h3 class="text-primary mb-4">
    <i class="bi bi-scissors me-2"></i> DANH SÁCH DỊCH VỤ & BẢNG GIÁ
</h3>

<div class="card p-3 mb-4 shadow-sm bg-light">
    <div class="row g-2 align-items-end">
        <div class="col-md-6">
            <label class="form-label fw-bold small">Tên Dịch Vụ</label>
            <input @bind="currentService.Name" class="form-control" placeholder="VD: Tắm gội toàn thân..." />
        </div>

        <div class="col-md-4">
            <label class="form-label fw-bold small">Giá Dịch Vụ</label>
            <div class="input-group">
                <input @bind="currentService.Price" type="number" class="form-control" placeholder="0" />
                <span class="input-group-text">VNĐ</span>
            </div>
        </div>

        <div class="col-md-2">
            @if (isEditing)
            {
                <div class="d-flex gap-1">
                    <button class="btn btn-success w-100" @onclick="SaveService" title="Lưu"><i class="bi bi-check-lg"></i></button>
                    <button class="btn btn-secondary w-100" @onclick="CancelEdit" title="Hủy"><i class="bi bi-x-lg"></i></button>
                </div>
            }
            else
            {
                <button class="btn btn-primary w-100" @onclick="SaveService" title="Thêm mới"><i class="bi bi-plus-circle"></i></button>
            }
        </div>
    </div>
</div>

<table class="table table-bordered table-hover align-middle shadow-sm">
    <thead class="table-primary text-center">
        <tr>
            <th style="width: 50px;">ID</th>
            <th class="text-start">Tên Dịch Vụ</th>
            <th style="width: 200px;">Giá Niêm Yết</th>
            <th style="width: 150px;">Thao Tác</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var s in services)
        {
            <tr>
                <td class="text-center fw-bold text-secondary">@s.Id</td>
                <td><span class="fw-bold text-dark">@s.Name</span></td>
                <td class="text-end fw-bold text-success">@s.Price.ToString("#,##0") đ</td>
                <td class="text-center">
                    <button class="btn btn-sm btn-warning me-2" @onclick="() => EditService(s)"><i class="bi bi-pencil-square"></i></button>
                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteService(s)"><i class="bi bi-trash3-fill"></i></button>
                </td>
            </tr>
        }
    </tbody>
</table>

@code {
    private List<Service> services = new List<Service>();
    private Service currentService = new Service();
    private bool isEditing = false;

    // URL API (Port 7225)
    private string apiUrl = "https://localhost:7225/api/services";

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        try
        {
            services = await Http.GetFromJsonAsync<List<Service>>(apiUrl) ?? new List<Service>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Lỗi load data: {ex.Message}");
            services = new List<Service>();
        }
    }

    private async Task SaveService()
    {
        if (!string.IsNullOrEmpty(currentService.Name) && currentService.Price > 0)
        {
            if (isEditing)
            {
                // GỌI API SỬA (PUT)
                await Http.PutAsJsonAsync($"{apiUrl}/{currentService.Id}", currentService);
                isEditing = false;
            }
            else
            {
                // GỌI API THÊM (POST)
                await Http.PostAsJsonAsync(apiUrl, currentService);
            }

            // Reset form và load lại danh sách
            currentService = new Service();
            await LoadData();
        }
    }

    private void EditService(Service s)
    {
        // Copy object
        currentService = new Service { Id = s.Id, Name = s.Name, Price = s.Price };
        isEditing = true;
    }

    private void CancelEdit()
    {
        currentService = new Service();
        isEditing = false;
    }

    private async Task DeleteService(Service s)
    {
        bool confirm = await Task.FromResult(true);
        if (confirm)
        {
            // GỌI API XÓA (DELETE)
            await Http.DeleteAsync($"{apiUrl}/{s.Id}");
            await LoadData();
        }
    }
}